# 附近玩家检测方案

> 第22天开发内容：多人密度检测系统

---

## 一、我们要解决什么问题？

在POI搜刮系统中，我们需要根据附近玩家数量来决定显示多少个POI：
- 人少的地方POI少
- 人多的地方POI多
- 保证每个玩家至少有1个可探索的POI

所以我们需要一个系统来检测"附近有多少其他玩家"。

---

## 二、核心思路

### 想象一个场景

你打开游戏地图，系统需要知道：
- 你现在在哪？（你的位置）
- 你周围1公里有几个其他玩家？（玩家密度）
- 应该给你显示多少个POI？（动态分配）

### 解决方案：位置上报 + 范围查询

```
每个玩家：定期告诉服务器"我在这里"
服务器：记住所有玩家的位置
查询时：数一数某个范围内有几个点
```

就像一个末世的"生存者雷达"——每个幸存者的终端会定期发出信号，中央系统记录所有信号源的位置，任何人都可以查询附近有多少其他幸存者。

---

## 三、位置上报机制

### 3.1 什么时候上报？

| 触发条件 | 说明 |
|---------|------|
| App启动时 | 立即上报一次当前位置 |
| 每30秒 | 定时上报，保持位置更新 |
| 移动超过50米 | 位置变化较大时立即上报 |
| App进入后台 | 标记为"离线" |

### 3.2 上报什么信息？

只上报最基本的信息：
- 玩家ID
- 经纬度坐标
- 上报时间

### 3.3 为什么是30秒？

这是一个平衡点：

- 太频繁（如5秒）→ 浪费流量和服务器资源
- 太慢（如5分钟）→ 位置不准确

30秒的理由：
- 正常步行30秒大约走50米
- 对于1公里范围的密度查询，这个精度足够
- 不会给服务器造成太大压力

---

## 四、判断玩家是否在线

### 规则

一个玩家如果**超过5分钟没有上报位置**，就认为他已经离线了。

### 为什么是5分钟？

- 正常情况下每30秒上报一次
- 允许2-3次上报失败（网络波动）
- 5分钟 = 10次上报机会，足够判断是否真的离开

### 在线状态的作用

只统计在线玩家，避免把离开的人也算进去。

比如：
- 玩家A上午10点在这里玩过，然后关了App
- 玩家B下午3点来到同一个地方
- 此时不应该把A算作"附近玩家"

---

## 五、查询附近玩家

### 查询逻辑

当玩家打开地图或开始探索时，系统会：

1. **画一个圆**：以玩家位置为圆心，1公里为半径
2. **数点**：统计这个圆内有多少其他玩家的位置点
3. **过滤**：只统计5分钟内活跃的玩家
4. **排除自己**：不把自己算进去

### 查询结果

返回一个数字，比如 `12`，表示附近1公里内有12个其他在线玩家。

### 密度等级

根据查询结果判断密度等级：

| 附近玩家数量 | 密度等级 | POI显示策略 |
|-------------|---------|------------|
| 0人 | 独行者 | 显示1个最近的POI |
| 1-5人 | 低密度 | 显示2-3个POI |
| 6-20人 | 中密度 | 显示4-6个POI |
| 20人以上 | 高密度 | 显示所有POI |

---

## 六、隐私保护

### 我们不暴露精确位置

虽然服务器知道每个玩家的位置，但我们**绝不**把其他玩家的具体位置暴露给任何人。

玩家能看到的只是：
- "附近有3个幸存者"（一个数字）
- 看不到他们在哪
- 看不到他们是谁

### 位置数据的用途

| 用途 | 是否允许 |
|-----|---------|
| 统计附近玩家数量 | ✅ 是 |
| 显示其他玩家具体位置 | ❌ 否 |
| 决定POI显示数量 | ✅ 是 |
| 分享给第三方 | ❌ 绝对不 |

这个设计保持了游戏的神秘感：你知道附近有人，但不知道他们在哪。

---

## 七、完整流程示例

### 场景1：玩家A在城市中心（高密度区域）

```
玩家A打开地图
    ↓
系统查询：1公里内有多少玩家？
    ↓
结果：25人（高密度）
    ↓
系统决定：显示所有附近真实POI
    ↓
MapKit搜索：找到15个真实地点
    ↓
玩家A看到：15个可探索的POI标记
```

### 场景2：玩家B在郊区公园（低密度区域）

```
玩家B打开地图
    ↓
系统查询：1公里内有多少玩家？
    ↓
结果：2人（低密度）
    ↓
系统决定：显示2-3个POI
    ↓
MapKit搜索：找到5个真实地点
    ↓
按距离排序，取最近的3个
    ↓
玩家B看到：3个可探索的POI标记
```

### 场景3：玩家C在荒郊野外（独行者）

```
玩家C打开地图
    ↓
系统查询：1公里内有多少玩家？
    ↓
结果：0人（只有自己）
    ↓
系统决定：保底显示1个POI
    ↓
MapKit搜索：1公里内找到1个便利店
    ↓
玩家C看到：1个可探索的POI标记
    ↓
如果1公里内没有POI：扩大到2公里搜索
```

---

## 八、与探索功能的整合

### POI搜索时机

**关键问题**：什么时候去搜索附近有哪些真实地点？

**答案**：玩家点击"开始探索"时搜索。

**为什么是这个时机？**

| 方案 | 时机 | 优点 | 缺点 |
|-----|------|------|------|
| 开始探索时搜索 | ✅ 选这个 | 数据最新、可结合密度 | 每次都要等加载 |
| 打开地图时搜索 | | 提前准备好 | 可能还没开始探索就加载了 |
| 定时刷新 | | 减少请求 | 可能不够及时 |

**探索过程中POI会变吗？**

**不会。** 一旦开始探索，POI列表就固定了。避免走着走着POI突然消失。

如果玩家想刷新POI，需要：**停止探索 → 重新开始探索**

### 探索开始时的完整流程

```
玩家点击"开始探索"
    ↓
1. 上报当前位置（确保自己被计入在线）
2. 查询附近玩家数量 → 得到密度等级
3. 根据密度决定显示几个POI
4. 调用 MapKit 搜索附近真实地点
5. 过滤掉该玩家冷却中的POI
6. 取最近的N个
7. 在地图上显示POI标记
8. 为这些POI设置地理围栏
    ↓
探索正式开始
```

### 探索过程中

1. 持续上报位置（每30秒）
2. 保持在线状态
3. 如果长时间不动，仍然算在线
4. POI列表保持不变

### 探索结束时

1. 上报最终位置
2. 清除地理围栏
3. 如果App进入后台，标记为离线

---

## 九、数据需求

### 需要存储什么

一张简单的表，记录每个玩家的位置信息：

| 字段 | 说明 |
|-----|------|
| 玩家ID | 唯一标识 |
| 经度 | 位置坐标 |
| 纬度 | 位置坐标 |
| 最后更新时间 | 判断是否在线 |
| 是否在线 | 快速过滤 |

### 需要的功能

1. **上报位置**
   - 输入：玩家ID、经度、纬度
   - 效果：更新该玩家的位置和时间

2. **查询附近玩家数量**
   - 输入：经度、纬度、半径（默认1000米）
   - 输出：附近在线玩家数量（不含自己）

3. **获取POI显示建议**
   - 输入：附近玩家数量
   - 输出：建议显示的POI数量

---

## 十、总结

| 问题 | 答案 |
|-----|------|
| 怎么知道附近有多少玩家？ | 每个玩家定期上报位置，查询时统计范围内的点数 |
| 多久上报一次？ | 30秒，或移动超过50米 |
| 怎么判断在线？ | 5分钟内有上报就算在线 |
| 会暴露其他玩家位置吗？ | 不会，只返回数量 |
| POI数量怎么定？ | 根据附近玩家密度动态调整 |

**核心理念**：

这个机制就像末世的"生存者雷达"——你知道附近有多少人，但不知道他们具体在哪。

这既提供了游戏需要的多人互动感（知道不是一个人在战斗），又保护了玩家隐私（没人知道你在哪）。

---

*附近玩家检测方案 v4.0*
*用于第22天开发*
